<!DOCTYPE html>
<html lang="en" class="light"> <!-- Default to light mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monty Hall Simulator</title>
    <!-- Tailwind CSS with Config for Dark Mode -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748', // Custom shade for dark mode panels
                            850: '#1a202c', // Darker background
                            950: '#0d1117', // Almost black
                        }
                    },
                    animation: {
                        'fade-out': 'fadeOut 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeOut: {
                            '0%': { opacity: '1', visibility: 'visible' },
                            '100%': { opacity: '0', visibility: 'hidden' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Updated Door CSS for better responsiveness */
        .door { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            width: 30%;           /* Fluid width */
            max-width: 140px;     /* Cap width on large screens */
            aspect-ratio: 2/3;    /* Maintain shape regardless of width */
            min-width: 0;         /* Allow shrinking on tiny screens */
        }

        /* 3D effect for doors */
        .door-inner { box-shadow: inset 0 -4px 0 rgba(0,0,0,0.1); }
        .chart-container { position: relative; height: 250px; width: 100%; }
        
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 bg-gray-50 dark:bg-gray-900 h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <!-- Splash Screen -->
    <div id="splashScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 text-white transition-opacity duration-500">
        <div class="text-center space-y-6 p-6 animate-pulse">
            <h1 class="text-5xl md:text-6xl font-extrabold text-amber-400 tracking-tight">Monty Hall</h1>
            <h2 class="text-2xl md:text-3xl font-light text-gray-300">Probability Simulator</h2>
            
            <div class="pt-8">
                <button id="startButton" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-full text-xl shadow-lg transform hover:scale-105 transition-all">
                    Start Simulation
                </button>
            </div>
            
            <div class="pt-12 text-gray-500 text-sm font-medium tracking-wider uppercase">
                Created by Gary Jamieson
            </div>
        </div>
    </div>

    <!-- Header / Navbar -->
    <header class="w-full bg-gray-900 dark:bg-gray-950 text-white p-4 flex justify-between items-center shadow-lg z-10 shrink-0">
        <h1 class="text-xl md:text-2xl font-bold tracking-tight text-amber-400">Monty Hall Simulator</h1>
        <div class="flex gap-2">
            <!-- Theme Toggle -->
            <button id="themeButton" class="p-2 rounded-full hover:bg-gray-700 transition focus:outline-none" title="Toggle Dark Mode">
                <span id="themeIcon">üåô</span>
            </button>
            <!-- Music Toggle -->
            <button id="musicButton" class="p-2 rounded-full hover:bg-gray-700 bg-gray-700 text-gray-400 transition focus:outline-none" title="Toggle Music">
                <span id="musicIcon">üéµ</span>
            </button>
            <!-- SFX Toggle -->
            <button id="muteButton" class="p-2 rounded-full hover:bg-gray-700 transition focus:outline-none" title="Toggle SFX">
                <span id="muteIcon">üîä</span>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Left: Game Arena -->
        <section class="flex-1 flex flex-col bg-gray-100 dark:bg-gray-850 relative overflow-y-auto transition-colors duration-300">
            <div class="flex-1 flex flex-col items-center justify-center p-4 md:p-6 min-h-[400px]">
                
                <!-- Feedback Message -->
                <div id="messageDisplay" class="text-lg md:text-2xl font-bold text-center mb-8 min-h-[3rem] text-blue-800 dark:text-blue-300 transition-colors px-2">
                    Pick a door to start!
                </div>

                <!-- Doors -->
                <div id="doorsContainer" class="flex justify-center gap-3 md:gap-8 w-full max-w-2xl mb-10 px-2">
                    <!-- Doors injected here -->
                </div>

                <!-- Manual Controls -->
                <div class="flex gap-4 mb-4">
                    <button id="resetButton" class="px-6 py-3 bg-gray-800 dark:bg-gray-700 text-white font-semibold rounded-lg shadow hover:bg-gray-700 dark:hover:bg-gray-600 hover:-translate-y-0.5 transition border border-transparent dark:border-gray-600">
                        Reset Game
                    </button>
                </div>
            </div>
        </section>

        <!-- Right: Simulation & Stats Panel -->
        <aside class="w-full md:w-[400px] lg:w-[450px] bg-white dark:bg-gray-800 border-t md:border-t-0 md:border-l border-gray-300 dark:border-gray-700 flex flex-col shadow-2xl z-20 overflow-y-auto transition-colors duration-300 shrink-0">
            
            <!-- Controls -->
            <div class="p-6 bg-gray-50 dark:bg-gray-750 border-b border-gray-200 dark:border-gray-700 transition-colors duration-300">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2">
                    <span>‚öôÔ∏è</span> Simulation Controls
                </h3>
                
                <div class="space-y-4">
                    <!-- Speed -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Speed</label>
                        <div class="flex bg-gray-200 dark:bg-gray-600 rounded p-1 transition-colors">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="simulationSpeed" value="instant" checked class="peer sr-only">
                                <span class="block py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300 peer-checked:bg-white dark:peer-checked:bg-gray-800 peer-checked:text-blue-600 dark:peer-checked:text-blue-400 peer-checked:shadow transition">Instant</span>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="simulationSpeed" value="fast" class="peer sr-only">
                                <span class="block py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300 peer-checked:bg-white dark:peer-checked:bg-gray-800 peer-checked:text-blue-600 dark:peer-checked:text-blue-400 peer-checked:shadow transition">Visual</span>
                            </label>
                        </div>
                    </div>

                    <!-- Strategy -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Strategy</label>
                        <div class="flex bg-gray-200 dark:bg-gray-600 rounded p-1 transition-colors">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="simulationStrategy" value="stay" class="peer sr-only">
                                <span class="block py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300 peer-checked:bg-white dark:peer-checked:bg-gray-800 peer-checked:text-green-600 dark:peer-checked:text-green-400 peer-checked:shadow transition">Stay</span>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="simulationStrategy" value="switch" class="peer sr-only">
                                <span class="block py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300 peer-checked:bg-white dark:peer-checked:bg-gray-800 peer-checked:text-purple-600 dark:peer-checked:text-purple-400 peer-checked:shadow transition">Switch</span>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="simulationStrategy" value="both" checked class="peer sr-only">
                                <span class="block py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300 peer-checked:bg-white dark:peer-checked:bg-gray-800 peer-checked:text-orange-600 dark:peer-checked:text-orange-400 peer-checked:shadow transition">Both</span>
                            </label>
                        </div>
                    </div>

                    <!-- Count & Run -->
                    <div class="flex gap-2">
                        <input type="number" id="simulationCount" value="1000" min="1" max="100000" class="w-1/3 p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-white rounded text-center font-mono" placeholder="N">
                        <button id="runSimulationButton" class="flex-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white font-bold rounded shadow transition">Run Sim</button>
                        <button id="stopSimulationButton" class="hidden flex-1 bg-red-500 hover:bg-red-600 text-white font-bold rounded shadow transition">Stop</button>
                    </div>
                     <button id="clearResultsButton" class="w-full text-xs text-red-500 hover:text-red-700 dark:hover:text-red-400 underline mt-1">Clear Data</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="flex-1 p-6 space-y-6">
                <!-- Stay Card -->
                <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 border border-green-100 dark:border-green-800/30">
                    <div class="flex justify-between items-end mb-2">
                        <h4 class="font-bold text-green-800 dark:text-green-400">Stay Strategy</h4>
                        <span id="stayWinRate" class="text-2xl font-black text-green-600 dark:text-green-400">0.0%</span>
                    </div>
                    <div class="flex text-sm text-gray-600 dark:text-gray-400 justify-between mb-2">
                         <span>Wins: <b id="stayWins" class="text-gray-900 dark:text-gray-200">0</b></span>
                         <span>Losses: <b id="stayLosses" class="text-gray-900 dark:text-gray-200">0</b></span>
                    </div>
                    <div class="chart-container h-32">
                        <canvas id="stayChart"></canvas>
                    </div>
                </div>

                <!-- Switch Card -->
                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-4 border border-purple-100 dark:border-purple-800/30">
                     <div class="flex justify-between items-end mb-2">
                        <h4 class="font-bold text-purple-800 dark:text-purple-400">Switch Strategy</h4>
                        <span id="switchWinRate" class="text-2xl font-black text-purple-600 dark:text-purple-400">0.0%</span>
                    </div>
                    <div class="flex text-sm text-gray-600 dark:text-gray-400 justify-between mb-2">
                         <span>Wins: <b id="switchWins" class="text-gray-900 dark:text-gray-200">0</b></span>
                         <span>Losses: <b id="switchLosses" class="text-gray-900 dark:text-gray-200">0</b></span>
                    </div>
                    <div class="chart-container h-32">
                        <canvas id="switchChart"></canvas>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Hidden audio element for looping music -->
    <audio id="bgMusic" src="ambient-piano-x-relaxing-prod-by-blackpybeats-109400.mp3" loop preload="auto"></audio>

    <script>
        // --- State Management ---
        const state = {
            doors: [false, false, false], // true = car
            gameStage: 'IDLE', // IDLE, PICKED, REVEALED, OVER
            picks: { initial: -1, goat: -1, final: -1 },
            stats: { stay: { wins: 0, losses: 0 }, switch: { wins: 0, losses: 0 } },
            isSimulating: false,
            isMuted: false, // SFX Mute
            isMusicOn: false, // Background Music state
            isDark: false,
            audioReady: false
        };

        // --- DOM Elements ---
        const els = {
            html: document.documentElement,
            doors: document.getElementById('doorsContainer'),
            msg: document.getElementById('messageDisplay'),
            charts: { stay: null, switch: null },
            audio: document.getElementById('bgMusic'),
            splash: document.getElementById('splashScreen'),
            inputs: {
                speed: document.getElementsByName('simulationSpeed'),
                strategy: document.getElementsByName('simulationStrategy'),
                count: document.getElementById('simulationCount')
            },
            btns: {
                run: document.getElementById('runSimulationButton'),
                stop: document.getElementById('stopSimulationButton'),
                clear: document.getElementById('clearResultsButton'),
                reset: document.getElementById('resetButton'),
                mute: document.getElementById('muteButton'),
                muteIcon: document.getElementById('muteIcon'),
                music: document.getElementById('musicButton'),
                musicIcon: document.getElementById('musicIcon'),
                theme: document.getElementById('themeButton'),
                themeIcon: document.getElementById('themeIcon'),
                start: document.getElementById('startButton')
            },
            displays: {
                stayWins: document.getElementById('stayWins'),
                stayLosses: document.getElementById('stayLosses'),
                stayRate: document.getElementById('stayWinRate'),
                switchWins: document.getElementById('switchWins'),
                switchLosses: document.getElementById('switchLosses'),
                switchRate: document.getElementById('switchWinRate')
            }
        };

        // --- Audio Setup (Lazy Load) ---
        const Audio = {
            synths: {},
            init: async () => {
                if (state.audioReady) return;
                await Tone.start();
                
                // Refined, understated sound design
                
                // PICK: Soft "glass" tap (High sine, quick decay)
                Audio.synths.pick = new Tone.Synth({ 
                    oscillator: { type: "sine" }, 
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1 } 
                }).toDestination();
                
                // GOAT: Low, dull thud (Membrane, tuned down)
                Audio.synths.goat = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 2,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.5 }
                }).toDestination();
                Audio.synths.goat.volume.value = -5; // Subtle
                
                // WIN: Soft Major Chord (PolySynth, Sine, gentle attack)
                Audio.synths.win = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 1.5 },
                    volume: -8
                }).toDestination();

                // LOSE: Soft dissonant low hum or single low note
                Audio.synths.lose = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.2, decay: 0.5, sustain: 0.2, release: 1.5 },
                    volume: -5
                }).toDestination();
                
                state.audioReady = true;
                console.log("Audio Engine Started");
            },
            play: (type) => {
                if (state.isMuted || !state.audioReady) return;
                // Don't play sounds during "Instant" sim
                if (state.isSimulating && getSimSpeed() === 'instant') return;

                switch(type) {
                    case 'pick': 
                        Audio.synths.pick.triggerAttackRelease("G6", "16n"); 
                        break;
                    case 'goat': 
                        Audio.synths.goat.triggerAttackRelease("C2", "8n"); 
                        break;
                    case 'win': 
                        // Gentle C Major 7
                        Audio.synths.win.triggerAttackRelease(["C5", "E5", "G5", "B5"], "4n"); 
                        break;
                    case 'lose': 
                        // Subtle low tone
                        Audio.synths.lose.triggerAttackRelease("C3", "2n"); 
                        break;
                }
            },
            toggleMusic: () => {
                state.isMusicOn = !state.isMusicOn;
                
                if (state.isMusicOn) {
                    els.audio.volume = 0.6; // 60% Volume
                    els.audio.play().catch(e => {
                        console.log("Music play failed (user interaction needed):", e);
                        state.isMusicOn = false; // Reset if failed
                    });
                } else {
                    els.audio.pause();
                }

                // Update UI
                if (state.isMusicOn) {
                    els.btns.music.classList.remove('bg-gray-700', 'text-gray-400');
                    els.btns.music.classList.add('bg-blue-600', 'text-white');
                } else {
                    els.btns.music.classList.add('bg-gray-700', 'text-gray-400');
                    els.btns.music.classList.remove('bg-blue-600', 'text-white');
                }
            }
        };

        // --- Core Logic ---
        
        function initGame() {
            // Create Doors FIRST to prevent rendering errors
            els.doors.innerHTML = '';
            for(let i=0; i<3; i++) {
                const d = document.createElement('div');
                // Base classes, colors injected via renderDoors
                d.className = `door rounded-lg shadow-md cursor-pointer flex items-center justify-center text-4xl font-bold door-inner select-none transition-all duration-300`;
                d.textContent = i + 1;
                d.onclick = () => handleDoorClick(i);
                els.doors.appendChild(d);
            }

            // Check system preference AFTER creating doors
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                toggleTheme(true);
            }
            
            initCharts();
            resetRound();
        }

        function toggleTheme(forceDark = null) {
            state.isDark = forceDark !== null ? forceDark : !state.isDark;
            
            if (state.isDark) {
                els.html.classList.add('dark');
                els.btns.themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                els.html.classList.remove('dark');
                els.btns.themeIcon.textContent = 'üåô';
            }
            
            // Re-render doors not strictly needed for logic but ensures class updates if state used
            // We can safely call it now that we fixed initialization order
            if (els.doors.children.length > 0) {
                 renderDoors();
            }
            // Update message color based on new theme
            updateMessageStyle();
        }

        function resetRound() {
            state.doors = [false, false, false];
            state.doors[Math.floor(Math.random() * 3)] = true;
            state.gameStage = 'IDLE';
            state.picks = { initial: -1, goat: -1, final: -1 };
            renderDoors();
            setMessage("Pick a door to start!", "text-blue-800 dark:text-blue-300");
        }

        // Updated handleDoorClick to accept fromSimulation flag
        function handleDoorClick(i, fromSimulation = false) {
            if (state.gameStage === 'OVER') return;
            
            // KEY FIX: Allow click if it comes from the simulation logic
            if (state.isSimulating && !fromSimulation) return; 
            
            // Manual play requires user interaction to start audio context
            if (!fromSimulation) Audio.init(); 

            if (state.gameStage === 'IDLE') {
                state.picks.initial = i;
                state.gameStage = 'PICKED';
                Audio.play('pick');
                
                // Monty opens a goat door
                const availableGoats = state.doors
                    .map((isCar, idx) => (idx !== i && !isCar) ? idx : -1)
                    .filter(idx => idx !== -1);
                state.picks.goat = availableGoats[Math.floor(Math.random() * availableGoats.length)];
                
                renderDoors();
                
                // Delay for goat reveal
                setTimeout(() => {
                    // Safety check: if user reset mid-animation
                    if(state.gameStage !== 'PICKED') return; 

                    Audio.play('goat');
                    state.gameStage = 'REVEALED';
                    renderDoors();
                    setMessage("Click your door to STAY, or the other to SWITCH.");
                }, 300);

            } else if (state.gameStage === 'REVEALED') {
                if (i === state.picks.goat) return; // Can't pick the goat
                
                state.picks.final = i;
                const won = state.doors[i];
                const strategy = (i === state.picks.initial) ? 'stay' : 'switch';
                
                // Record Stats
                if(won) state.stats[strategy].wins++;
                else state.stats[strategy].losses++;

                finishRound(won);
            }
        }

        function finishRound(won) {
            state.gameStage = 'OVER';
            renderDoors(); // Reveal all
            updateStatsUI();
            if (won) {
                setMessage("YOU WON! üöó", "text-green-600 dark:text-green-400");
                Audio.play('win');
            } else {
                setMessage("Got the GOAT! üêê", "text-red-600 dark:text-red-400");
                Audio.play('lose');
            }
        }

        // --- Rendering ---

        function renderDoors() {
            const doorDivs = els.doors.children;
            if (doorDivs.length < 3) return; // Safety Check

            for(let i=0; i<3; i++) {
                const div = doorDivs[i];
                div.className = `door rounded-lg shadow-md flex items-center justify-center text-4xl font-bold transition-transform transform duration-300 `;
                
                // Default State
                let bg = "bg-amber-200 dark:bg-amber-600 text-amber-800 dark:text-amber-100 hover:bg-amber-300 dark:hover:bg-amber-500";
                let content = i + 1;
                let border = "";
                let scale = "";

                // Logic to styling
                if (state.gameStage === 'OVER') {
                    // Reveal Everything
                    if (state.doors[i]) {
                        bg = "bg-green-500 dark:bg-green-600 text-white"; // Car
                        content = "üöó";
                    } else {
                        bg = "bg-red-400 dark:bg-red-500 text-white"; // Goat
                        content = "üêê";
                    }
                    if (i === state.picks.final) border = "ring-4 ring-offset-2 ring-blue-600 dark:ring-blue-400 dark:ring-offset-gray-850";
                } else {
                    // Ongoing Game
                    if (i === state.picks.goat && (state.gameStage === 'REVEALED' || state.gameStage === 'PICKED')) {
                        bg = "bg-red-200 dark:bg-red-900/50 text-red-800 dark:text-red-200";
                        content = "üêê";
                    }
                    else if (i === state.picks.initial) {
                        bg = "bg-blue-500 text-white";
                        border = "ring-4 ring-blue-300 dark:ring-blue-700";
                        scale = "scale-105";
                    }
                }

                // Apply compiled classes
                div.className += `${bg} ${border} ${scale}`;
                div.textContent = content;

                // Disable interaction if needed
                if (state.isSimulating || (state.gameStage === 'REVEALED' && i === state.picks.goat)) {
                    div.style.cursor = 'default';
                } else {
                    div.style.cursor = 'pointer';
                }
            }
        }

        function setMessage(txt, colorClass = "text-gray-800 dark:text-gray-100") {
            els.msg.textContent = txt;
            els.msg.dataset.baseClass = colorClass || "text-gray-800 dark:text-gray-100";
            updateMessageStyle();
        }

        function updateMessageStyle() {
            const baseClass = els.msg.dataset.baseClass || "text-gray-800 dark:text-gray-100";
            // If the base class doesn't have dark mode specific overrides, default text color applies
            els.msg.className = `text-xl md:text-2xl font-bold text-center mb-10 min-h-[3rem] transition-colors ${baseClass}`;
        }

        // --- Simulation Engine ---

        function getSimSpeed() {
            return Array.from(els.inputs.speed).find(r => r.checked).value;
        }

        function getSimStrategy() {
            return Array.from(els.inputs.strategy).find(r => r.checked).value;
        }

        async function runSimulation() {
            Audio.init();
            const count = parseInt(els.inputs.count.value) || 100;
            const speed = getSimSpeed();
            const strategyMode = getSimStrategy(); // stay, switch, both
            
            state.isSimulating = true;
            updateControls();
            
            // PURE MATH MODE (Instant)
            if (speed === 'instant') {
                setMessage("Calculating results...", "text-purple-600 dark:text-purple-400");
                // Allow UI to update before blocking thread
                await new Promise(r => setTimeout(r, 10)); 

                const strategies = strategyMode === 'both' ? ['stay', 'switch'] : [strategyMode];
                
                strategies.forEach(strat => {
                    let localWins = 0;
                    for(let i=0; i<count; i++) {
                        const car = Math.floor(Math.random() * 3);
                        const initialPick = Math.floor(Math.random() * 3);
                        // Stay: Win if pick == car
                        // Switch: Win if pick != car
                        if (strat === 'stay' && car === initialPick) localWins++;
                        if (strat === 'switch' && car !== initialPick) localWins++;
                    }
                    state.stats[strat].wins += localWins;
                    state.stats[strat].losses += (count - localWins);
                });

                updateStatsUI();
                setMessage(`Simulated ${count} games instantly.`);
                state.isSimulating = false;
                resetRound();
                updateControls();
                return;
            }

            // VISUAL MODE (Slower)
            let runs = [];
            if (strategyMode === 'both') {
                // Randomly mix 'stay' and 'switch' for visual mode
                for(let i=0; i<count; i++) {
                    runs.push(Math.random() < 0.5 ? 'stay' : 'switch');
                }
            } else {
                for(let i=0; i<count; i++) runs.push(strategyMode);
            }

            for (let i = 0; i < runs.length; i++) {
                if (!state.isSimulating) break; // Stop button pressed
                
                const strat = runs[i];
                setMessage(`Simulating Game ${i+1}/${runs.length} (${strat.toUpperCase()})`);
                
                // Logic for visual run
                resetRound();
                await delay(150); 
                
                // Pick
                const pick = Math.floor(Math.random() * 3);
                handleDoorClick(pick, true); // Pass true to bypass isSimulating guard
                await delay(400); // Wait for pick + goat reveal delay (300ms)
                
                // Ensure the stage is REVEALED before proceeding
                if(state.gameStage !== 'REVEALED') await delay(100);

                // Final Decision
                const currentGoat = state.picks.goat;
                let finalDoor = pick;
                if (strat === 'switch') {
                    finalDoor = [0,1,2].find(d => d !== pick && d !== currentGoat);
                }
                
                handleDoorClick(finalDoor, true); // Final click, bypass guard
                await delay(600); // Show result briefly
            }

            state.isSimulating = false;
            updateControls();
            if(state.gameStage === 'OVER') resetRound();
        }

        function delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        // --- Chart & UI Helpers ---

        function updateControls() {
            els.btns.run.classList.toggle('hidden', state.isSimulating);
            els.btns.stop.classList.toggle('hidden', !state.isSimulating);
            els.inputs.count.disabled = state.isSimulating;
        }

        function updateStatsUI() {
            // Stay Stats
            els.displays.stayWins.textContent = state.stats.stay.wins;
            els.displays.stayLosses.textContent = state.stats.stay.losses;
            const stayTotal = state.stats.stay.wins + state.stats.stay.losses;
            els.displays.stayRate.textContent = stayTotal ? ((state.stats.stay.wins / stayTotal) * 100).toFixed(1) + "%" : "0.0%";
            updateChart(els.charts.stay, state.stats.stay.wins, state.stats.stay.losses);

            // Switch Stats
            els.displays.switchWins.textContent = state.stats.switch.wins;
            els.displays.switchLosses.textContent = state.stats.switch.losses;
            const switchTotal = state.stats.switch.wins + state.stats.switch.losses;
            els.displays.switchRate.textContent = switchTotal ? ((state.stats.switch.wins / switchTotal) * 100).toFixed(1) + "%" : "0.0%";
            updateChart(els.charts.switch, state.stats.switch.wins, state.stats.switch.losses);
        }

        function initCharts() {
            Chart.defaults.font.family = 'Inter';
            const commonConfig = {
                type: 'doughnut',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    cutout: '70%',
                    elements: { arc: { borderWidth: 0 } }
                }
            };

            els.charts.stay = new Chart(document.getElementById('stayChart'), {
                ...commonConfig,
                data: { labels: ['Wins', 'Losses'], datasets: [{ data: [0,0], backgroundColor: ['#22c55e', '#bbf7d0'], hoverBackgroundColor: ['#16a34a', '#86efac'] }] }
            });

            els.charts.switch = new Chart(document.getElementById('switchChart'), {
                ...commonConfig,
                data: { labels: ['Wins', 'Losses'], datasets: [{ data: [0,0], backgroundColor: ['#9333ea', '#e9d5ff'], hoverBackgroundColor: ['#7e22ce', '#d8b4fe'] }] }
            });
        }

        function updateChart(chart, wins, losses) {
            chart.data.datasets[0].data = [wins, losses];
            // If empty, show a grey ring
            if (wins + losses === 0) chart.data.datasets[0].data = [0, 1]; 
            chart.update();
        }

        // --- Event Listeners ---
        els.btns.reset.onclick = () => { resetRound(); Audio.play('pick'); };
        els.btns.clear.onclick = () => {
            state.stats = { stay: { wins: 0, losses: 0 }, switch: { wins: 0, losses: 0 } };
            updateStatsUI();
        };
        els.btns.run.onclick = runSimulation;
        els.btns.stop.onclick = () => { state.isSimulating = false; };
        
        els.btns.mute.onclick = () => {
            state.isMuted = !state.isMuted;
            els.btns.muteIcon.textContent = state.isMuted ? 'üîá' : 'üîä';
            els.btns.mute.classList.toggle('bg-red-100', state.isMuted);
            els.btns.mute.classList.toggle('text-gray-800', state.isMuted);
        };
        
        els.btns.music.onclick = Audio.toggleMusic;

        els.btns.theme.onclick = () => toggleTheme();
        
        // Splash Screen Start
        els.btns.start.onclick = async () => {
            // Unlock audio on click
            await Audio.init();
            // Hide splash screen
            els.splash.classList.add('animate-fade-out');
        };

        // Initialize
        initGame();

    </script>
</body>
</html>
